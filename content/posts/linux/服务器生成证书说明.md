---
title: "服务器生成证书说明"
date: 2023-02-07T10:42:28+08:00
description: "在服务器上生成https证书"
tags: ["linux"]
featured_image: ""
# images is optional, but needed for showing Twitter Card
images: []
categories: linux
comment : true
---

> 此文档使用的系统:  WSL2-ArchLinux 进行的以下操作：建议用root账号进行操作，并在统一目录下操作。

---

## 生成CA证书

1. 生成CA私钥

```zsh
openssl genrsa -des3 -out ca.key 2048
```

此命令应该会要求你输入一个ca.key对应的加密密码（可以输入个123456方便记）。输入后密码需要记下来后面还要用。

2. 生成不加密的CA私钥

```zsh
openssl genrsa -out ca_decrypted.key 2048
```

3. 生成CA公钥即CA根证书

```zsh
openssl req -new -x509 -days 3650 -key ca.key -out ca.crt
```

输入命令后应该会需要你输入一些证书相关的周边信息。比如证书颁发机构所在地址，机构名称等等。，唯一需要注意的是Common Name那一栏。为了后面操作顺利，建议将这里填写**主机名或者主机IP**。

---

## 生成HTTPS证书的准备

创建ssl.cnf文件并写入内容

```zsh
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1= localhost
DNS.2= localhost.loacl
IP.1 = 192.168.1.1
IP.2 = 192.168.1.2
```

其中`IP.*`项看自己需要写自己的ip，可以写多个。

---

## 生成HTTPS证书

1. 生成HTTPS证书私钥

```zsh
openssl genrsa -des3 -out xxxx.pem 1024
```

这里的xxxx指的就是上面说的主机名或者主机IP，下面的同理

2. 生成不加密的https主机证书私钥

```zsh
openssl rsa -in xxxx.pem -out xxxx.key
```

3. 生成签名请求

```zsh
openssl req -new -key xxxx.pem -out xxxx.csr
```

注意ssl.cnf的路径和上面自己创建的路径保持一致　其中，policy参数允许签名的CA和网站证书可以有不同的国家、地名等信息，days参数则是签名时限。唯一需要注意的是Common Name那一栏。为了后面操作顺利，按照我现有的实践将这里填写**主机名或者主机IP****。<font color="red">提示输入密码时不要输入，直接回车</font>

4. 用CA进行签名

```zsh
openssl ca -policy policy_anything -days 3650 -cert ca.crt -keyfile ca.key  -extfile ssl.cnf  -in xxx.csr -out xxx.crt
```

提示输入y/n时直接y

> 如果已经生成CA证书，后续其实可以不再生成CA，直接用原来的；
>
> 如果已经生成过证书了，后续要生成别的ip的证书，可以在同一个目录下，直接从HTTPS的第二步开始操作也行。

---

## 可能遇到的问题

提示找不到文件index.txt和serial时创建对应的文件即可

```zsh
# touch CA/index.txt
# echo '01' > CA/serial
```

***如果已经生成CA证书，后续其实可以不再生成CA，直接用原来的***

***如果已经生成过证书了，后续要生成别的ip的证书，可以在同一个目录下，直接从HTTPS的第二步开始操作也行。***

---

## 导入证书

1. 在nginx的server配置块中（或者新建一个server配置块）修改或新增如下：

```cnf
listen 443;

ssl on;

ssl_certificate /path/to/xxxx.crt;

ssl_certificate_key /path/to/xxxx.key;
keepalive_timeout 70;
```

然后将服务器上的这两个文件内容替换成我们生成的HTTPS对应的crt和key的内容（也就是上面HTTPS的第2步和第4步生成的东西），重启nginx

2. 在浏览器中点击地址栏前的`不安全`的红色叹号那个位置》》点击证书》》点击详细信息》》导出
3. 在浏览器设置中搜索证书》》管理设备证书》》导入》》选择刚刚导出的证书》》选择`将所有的证书都放入下列储存`》点击`受信任的根证书颁发机构`》》确定
4. 双击`ca.crt`进行根证书安装》》本地计算机》》选择`将所有的证书都放入下列储存`》点击`受信任的根证书颁发机构`》》确定